{
  "html_elements": [
    {
      "tag": "div",
      "attributes": {
        "class": "header"
      },
      "children": [
        {
          "tag": "img",
          "attributes": {
            "src": "https://goldmineshedsales.com/hubfs/Goldmine%20Logo%20Cropped%20Latest.png",
            "alt": "Gold Mine Shed Sales Logo"
          }
        }
      ]
    },
    {
      "tag": "div",
      "attributes": {
        "id": "controls"
      },
      "children": [
        {
          "tag": "div",
          "attributes": {
            "class": "dropdown"
          },
          "children": [
            {
              "tag": "button",
              "attributes": {
                "id": "companyFilterButton"
              },
              "text": "Select Companies"
            },
            {
              "tag": "div",
              "attributes": {
                "class": "dropdown-content",
                "id": "companyFilter"
              },
              "children": [
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Quality Structures"
                      }
                    },
                    "text": " Quality Structures"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Champion Buildings"
                      }
                    },
                    "text": " Champion Buildings"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Bitterroot Shedz"
                      }
                    },
                    "text": " Bitterroot Shedz"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "TruPoint Backyards"
                      }
                    },
                    "text": " TruPoint Backyards"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Mountain View Barns"
                      }
                    },
                    "text": " Mountain View Barns"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Eshs Utility Buildings"
                      }
                    },
                    "text": " Eshs Utility Buildings"
                  ]
                }
              ]
            }
          ]
        },
        {
          "tag": "div",
          "attributes": {
            "class": "dropdown"
          },
          "children": [
            {
              "tag": "button",
              "attributes": {
                "id": "leadStatusFilterButton"
              },
              "text": "Select Lead Status"
            },
            {
              "tag": "div",
              "attributes": {
                "class": "dropdown-content",
                "id": "leadStatusFilter"
              },
              "children": [
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "ATTEMPTED_TO_CONTACT"
                      }
                    },
                    "text": " Attempted to Contact"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "IN_PROGRESS"
                      }
                    },
                    "text": " In Progress"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Not Interested"
                      }
                    },
                    "text": " Not Interested"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Bad Number"
                      }
                    },
                    "text": " Bad Number"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Wrong Number"
                      }
                    },
                    "text": " Wrong Number"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Planning Far Out"
                      }
                    },
                    "text": " Planning Far Out"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "nurture"
                      }
                    },
                    "text": " Nurture"
                  ]
                },
                  {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Out Of Territory"
                      }
                    },
                    "text": " Out Of Territory"
                  ]
                },
                  {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Customer"
                      }
                    },
                    "text": " Customer"
                  ]
                },
                  {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "UNQUALIFIED"
                      }
                    },
                    "text": " No Buildable Solution"
                  ]
                },
                   {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                        "value": "Non-GM Serve"
                      }
                    },
                    "text": " Non-GM Serve"
                  ]
                },
                {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                         "value": "Previous Customer"
                      }
                    },
                    "text": " Previous Customer"
                  ]
                },
                 {
                  "tag": "label",
                  "children": [
                    {
                      "tag": "input",
                      "attributes": {
                        "type": "checkbox",
                         "value": "Bought From Competitor"
                      }
                    },
                    "text": " Bought From Competitor"
                  ]
                }
              ]
            }
          ]
        },
        {
         "tag": "div",
          "attributes": {
            "class": "dropdown"
          },
          "children": [
            {
              "tag": "button",
              "attributes": {
                "id": "dateFilterButton"
              },
              "text": "Select Date Range"
             },
            {
              "tag": "div",
              "attributes": {
                 "class": "dropdown-content",
                "id": "dateFilter"
              },
              "children":[
                  {
                    "tag": "label",
                    "attributes":{
                      "for": "startDate"
                    },
                    "text":"Start Date:"
                   },
                  {
                    "tag": "input",
                    "attributes":{
                      "type": "date",
                      "id":"startDate"
                    }
                   },
                  {
                   "tag": "label",
                    "attributes":{
                      "for": "endDate"
                    },
                   "text": "End Date:"
                 },
                {
                  "tag": "input",
                  "attributes":{
                    "type": "date",
                    "id":"endDate"
                   }
                 }
              ]
            }
          ]
         },
          {
          "tag": "button",
          "attributes": {
            "onclick": "toggleHeatmap()"
          },
          "text": "Toggle Heatmap/Pins"
        },
        {
          "tag": "button",
          "attributes": {
            "onclick": "refreshData()"
          },
          "text": "Refresh Data"
        },
        {
          "tag": "button",
          "attributes": {
            "onclick": "calculateRecordCount()"
           },
          "text": "Calculate Record Count"
        }
      ]
    },
    {
      "tag": "div",
      "attributes": {
        "id": "map-container"
      },
      "children": [
        {
          "tag": "div",
          "attributes": {
            "id": "map"
          }
        }
      ]
    },
    {
      "tag": "div",
      "attributes": {
        "id": "legend"
      },
      "children": [
        {
          "tag": "div",
          "children": [
            {
              "tag": "span",
              "attributes": {
                "style": "background-color: #FF6347;"
              }
            },
            "text": " Quality Structures"
          ]
        },
        {
          "tag": "div",
          "children": [
            {
              "tag": "span",
              "attributes": {
                "style": "background-color: #4682B4;"
              }
            },
            "text": " Champion Buildings"
          ]
        },
        {
          "tag": "div",
          "children": [
            {
              "tag": "span",
              "attributes": {
                "style": "background-color: #32CD32;"
              }
            },
            "text": " Bitterroot Shedz"
          ]
        },
         {
          "tag": "div",
          "children": [
            {
              "tag": "span",
              "attributes": {
                "style": "background-color: #FFD700;"
              }
            },
            "text": " TruPoint Backyards"
          ]
        },
         {
          "tag": "div",
          "children": [
            {
              "tag": "span",
              "attributes": {
                "style": "background-color: #FF69B4;"
              }
            },
            "text": " Mountain View Barns"
          ]
        },
         {
          "tag": "div",
          "children": [
            {
              "tag": "span",
              "attributes": {
                "style": "background-color: #8A2BE2;"
              }
            },
            "text": " Eshs Utility Buildings"
          ]
        }
      ]
    },
     {
      "tag": "div",
      "attributes": {
        "id": "record-count"
      },
       "children":[
         "Records in view: ",
        {
          "tag": "span",
          "attributes": {
            "id": "record-count-number"
          },
           "text": "0"
        }
       ]
    },
    {
      "tag": "script",
      "text": "// Global variables\n        let cachedData = null;\n        let isHeatmap = true;\n\n        // Event listeners for filters and buttons\n        document.getElementById('companyFilterButton').addEventListener('click', function(e) {\n            e.stopPropagation();\n            const dropdown = this.parentElement;\n            dropdown.classList.toggle('active');\n        });\n\n        document.getElementById('leadStatusFilterButton').addEventListener('click', function(e) {\n            e.stopPropagation();\n            const dropdown = this.parentElement;\n            dropdown.classList.toggle('active');\n        });\n\n        // Event listeners for the new Date Filter\n        document.getElementById('dateFilterButton').addEventListener('click', function(e) {\n            e.stopPropagation();\n            const dropdown = this.parentElement;\n            dropdown.classList.toggle('active');\n        });\n\n        document.addEventListener('click', function(e) {\n            const dropdowns = document.querySelectorAll('.dropdown');\n            dropdowns.forEach(dropdown => {\n                if (!dropdown.contains(e.target)) {\n                    dropdown.classList.remove('active');\n                }\n            });\n        });\n\n        // Update filter button texts when any filter changes\n        document.querySelectorAll('#companyFilter input, #leadStatusFilter input, #startDate, #endDate').forEach(element => {\n            element.addEventListener('change', () => {\n                updateFilterButtonText();\n                if (cachedData && window.displayData) {\n                    window.displayData(cachedData);\n                }\n            });\n        });\n\n        function updateFilterButtonText() {\n            const selectedCompanies = Array.from(document.querySelectorAll(\"#companyFilter input:checked\")).map(input => input.value);\n            document.getElementById('companyFilterButton').textContent = selectedCompanies.length > 0 \n                ? `${selectedCompanies.length} Companies Selected`\n                : 'Select Companies';\n\n            const selectedStatuses = Array.from(document.querySelectorAll(\"#leadStatusFilter input:checked\")).map(input => input.value);\n            document.getElementById('leadStatusFilterButton').textContent = selectedStatuses.length > 0\n                ? `${selectedStatuses.length} Statuses Selected`\n                : 'Select Lead Status';\n\n            const startDate = document.getElementById('startDate').value;\n            const endDate = document.getElementById('endDate').value;\n            if (startDate && endDate) {\n                document.getElementById('dateFilterButton').textContent = `${startDate} to ${endDate}`;\n            } else if (startDate) {\n                document.getElementById('dateFilterButton').textContent = `From ${startDate}`;\n            } else if (endDate) {\n                document.getElementById('dateFilterButton').textContent = `Up to ${endDate}`;\n            } else {\n                document.getElementById('dateFilterButton').textContent = 'Select Date Range';\n            }\n        }\n\n        function refreshData() {\n            const url = `https://storage.googleapis.com/contact-address-bucket/contacts.csv?t=${Date.now()}`;\n            const refreshButton = document.querySelector('button[onclick=\"refreshData()\"]');\n            \n            refreshButton.disabled = true;\n            refreshButton.style.opacity = '0.7';\n            refreshButton.textContent = 'Refreshing...';\n\n            fetch(url)\n                .then(response => response.ok ? response.text() : Promise.reject(response))\n                .then(csvData => {\n                    cachedData = parseCSV(csvData);\n                    if (window.displayData) {\n                        window.displayData(cachedData);\n                    }\n                    \n                    refreshButton.style.backgroundColor = '#45a049';\n                    refreshButton.textContent = 'Data Updated!';\n                    setTimeout(() => {\n                        refreshButton.style.backgroundColor = '#4CAF50';\n                        refreshButton.textContent = 'Refresh Data';\n                        refreshButton.disabled = false;\n                    }, 2000);\n                })\n                .catch(error => {\n                    console.error(\"Error loading data:\", error);\n                    \n                    refreshButton.style.backgroundColor = '#f44336';\n                    refreshButton.textContent = 'Error Refreshing';\n                    setTimeout(() => {\n                        refreshButton.style.backgroundColor = '#4CAF50';\n                        refreshButton.textContent = 'Refresh Data';\n                        refreshButton.disabled = false;\n                    }, 2000);\n                });\n        }\n\n        function parseCSV(csvData) {\n            const lines = csvData.trim().split('\\n').filter(line => line.trim());\n            const headers = lines[0].split(',').map(header => header.trim().replace(/^\"|\"$/g, ''));\n            const data = [];\n            lines.slice(1).forEach(line => {\n                const values = line.match(/(\".*?\"|[^\",]+)(?=\\s*,|\\s*$)/g) || [];\n                const row = headers.reduce((obj, header, index) => {\n                    obj[header] = values[index]?.replace(/^\"|\"$/g, '').trim() || \"\";\n                    return obj;\n                }, {});\n                row.latitude = parseFloat(row.latitude || row.lat);\n                row.longitude = parseFloat(row.longitude || row.lng || row.long);\n                if (!isNaN(row.latitude) && !isNaN(row.longitude)) data.push(row);\n            });\n            return data;\n        }\n\n        // Initialize the map and related functions after the API has loaded\n        function initMap() {\n            // Map-related variables\n            let map;\n            let heatmap;\n            let markers = [];\n            let currentClusterer = null;\n            let currentViewport = null;\n\n            const companyColors = {\n                \"quality structures\": \"#FF6347\",\n                \"champion buildings\": \"#4682B4\",\n                \"bitterroot shedz\": \"#32CD32\",\n                \"trupoint backyards\": \"#FFD700\",\n                \"mountain view barns\": \"#FF69B4\",\n                \"eshs utility buildings\": \"#8A2BE2\"\n            };\n\n            const markerIcons = {};\n            Object.entries(companyColors).forEach(([company, color]) => {\n                markerIcons[company] = {\n                    path: google.maps.SymbolPath.CIRCLE,\n                    scale: 8,\n                    fillColor: color,\n                    fillOpacity: 1,\n                    strokeWeight: 1\n                };\n            });\n\n            map = new google.maps.Map(document.getElementById(\"map\"), {\n                center: { lat: 44.3148, lng: -85.6024 },\n                zoom: 8,\n                mapId: \"39252d46211cfba9\",\n            });\n            \n            map.addListener('idle', () => {\n                currentViewport = map.getBounds();\n                if (cachedData && !isHeatmap) {\n                    displayData(cachedData);\n                }\n            });\n            \n            map.controls[google.maps.ControlPosition.LEFT_TOP].push(document.getElementById(\"record-count\"));\n            map.controls[google.maps.ControlPosition.RIGHT_TOP].push(document.getElementById(\"legend\"));\n            fetchData();\n\n            function fetchData() {\n                const url = \"https://storage.googleapis.com/contact-address-bucket/contacts.csv\";\n                fetch(url)\n                    .then(response => response.ok ? response.text() : Promise.reject(response))\n                    .then(csvData => {\n                        cachedData = parseCSV(csvData);\n                        displayData(cachedData);\n                    })\n                    .catch(error => console.error(\"Error loading data:\", error));\n            }\n\n            function displayData(data) {\n                clearMap();\n                const selectedCompanies = Array.from(document.querySelectorAll(\"#companyFilter input:checked\")).map(input => input.value.toLowerCase());\n                const selectedLeadStatuses = Array.from(document.querySelectorAll(\"#leadStatusFilter input:checked\")).map(input => input.value);\n                const startDateValue = document.getElementById('startDate').value;\n                const endDateValue = document.getElementById('endDate').value;\n\n                let filteredData = data.filter(row => {\n                    const companyName = row.properties_shed_company?.trim().toLowerCase();\n                    const companyMatch = selectedCompanies.length === 0 || selectedCompanies.includes(companyName);\n                    const statusMatch = selectedLeadStatuses.length === 0 || selectedLeadStatuses.includes(row.properties_hs_lead_status);\n                    \n                    // Date filtering\n                    let dateMatch = true;\n                    if (startDateValue) {\n                        const rowDate = new Date(row.properties_createdate);\n                        const startDate = new Date(startDateValue);\n                        startDate.setHours(0, 0, 0, 0);\n                        dateMatch = rowDate >= startDate;\n                    }\n                    if (endDateValue) {\n                        const rowDate = new Date(row.properties_createdate);\n                        const endDate = new Date(endDateValue);\n                        endDate.setHours(23, 59, 59, 999);\n                        dateMatch = dateMatch && (rowDate <= endDate);\n                    }\n\n                    return companyMatch && statusMatch && dateMatch;\n                });\n\n                if (currentViewport && !isHeatmap) {\n                    filteredData = filteredData.filter(row => {\n                        return currentViewport.contains({ lat: row.latitude, lng: row.longitude });\n                    });\n                }\n\n                const validData = filteredData.filter(row => row.latitude && row.longitude);\n                document.getElementById(\"legend\").style.display = isHeatmap ? \"none\" : \"block\";\n\n                if (isHeatmap) {\n                    heatmap = new google.maps.visualization.HeatmapLayer({\n                        data: validData.map(row => ({\n                            location: new google.maps.LatLng(row.latitude, row.longitude),\n                            weight: 1\n                        })),\n                        map: map,\n                        dissipating: true,\n                        radius: 15,\n                        opacity: 0.5,\n                    });\n                } else {\n                    validData.forEach(row => {\n                        const companyKey = row.properties_shed_company?.trim().toLowerCase();\n                        const markerIcon = markerIcons[companyKey] || {\n                            path: google.maps.SymbolPath.CIRCLE,\n                            scale: 8,\n                            fillColor: \"#FF0000\",\n                            fillOpacity: 1,\n                            strokeWeight: 1\n                        };\n                        \n                        const marker = new google.maps.Marker({\n                            position: { lat: row.latitude, lng: row.longitude },\n                            title: row.properties_shed_company || \"Shed Location\",\n                            icon: markerIcon\n                        });\n                        markers.push(marker);\n                    });\n\n                    currentClusterer = new markerClusterer.MarkerClusterer({\n                        map,\n                        markers,\n                        algorithm: new markerClusterer.SuperClusterAlgorithm({\n                            radius: 100,\n                            maxZoom: 14,\n                            minPoints: 5\n                        }),\n                        renderer: {\n                            render: ({ count, position }) => {\n                                return new google.maps.Marker({\n                                    position,\n                                    icon: {\n                                        path: google.maps.SymbolPath.CIRCLE,\n                                        scale: Math.log10(count) * 8 + 12,\n                                        fillColor: \"#4285F4\",\n                                        fillOpacity: 0.7,\n                                        strokeWeight: 1,\n                                        strokeColor: \"#FFFFFF\"\n                                    },\n                                    label: {\n                                        text: String(count),\n                                        color: \"white\",\n                                        fontSize: \"12px\"\n                                    },\n                                    zIndex: 1000 + count\n                                });\n                            }\n                        },\n                        onClusterClick: (_, cluster, map) => {\n                            const zoom = Math.min(map.getZoom() + 2, 14);\n                            map.setZoom(zoom);\n                            map.setCenter(cluster.position);\n                        }\n                    });\n                }\n            }\n\n            function clearMap() {\n                if (heatmap) heatmap.setMap(null);\n                if (currentClusterer) {\n                    currentClusterer.clearMarkers();\n                    currentClusterer = null;\n                }\n                markers.forEach(marker => marker.setMap(null));\n                markers = [];\n            }\n\n            // Expose functions to the global scope\n            window.displayData = displayData;\n            window.toggleHeatmap = function() {\n                isHeatmap = !isHeatmap;\n                if (cachedData) {\n                    displayData(cachedData);\n                }\n            };\n\n            // Calculate Record Count Function\n            function calculateRecordCount() {\n                if (!cachedData) {\n                    alert('Data is not loaded yet.');\n                    return;\n                }\n                \n                const bounds = map.getBounds();\n                if (!bounds) {\n                    alert('Map bounds are not available.');\n                    return;\n                }\n\n                const selectedCompanies = Array.from(document.querySelectorAll(\"#companyFilter input:checked\")).map(input => input.value.toLowerCase());\n                const selectedLeadStatuses = Array.from(document.querySelectorAll(\"#leadStatusFilter input:checked\")).map(input => input.value);\n                const startDateValue = document.getElementById('startDate').value;\n                const endDateValue = document.getElementById('endDate').value;\n\n                let filteredData = cachedData.filter(row => {\n                    const companyName = row.properties_shed_company?.trim().toLowerCase();\n                    const companyMatch = selectedCompanies.length === 0 || selectedCompanies.includes(companyName);\n                    const statusMatch = selectedLeadStatuses.length === 0 || selectedLeadStatuses.includes(row.properties_hs_lead_status);\n                    \n                    // Date filtering\n                    let dateMatch = true;\n                    if (startDateValue) {\n                        const rowDate = new Date(row.properties_createdate);\n                        const startDate = new Date(startDateValue);\n                        startDate.setHours(0, 0, 0, 0);\n                        dateMatch = rowDate >= startDate;\n                    }\n                    if (endDateValue) {\n                        const rowDate = new Date(row.properties_createdate);\n                        const endDate = new Date(endDateValue);\n                        endDate.setHours(23, 59, 59, 999);\n                        dateMatch = dateMatch && (rowDate <= endDate);\n                    }\n\n                    return companyMatch && statusMatch && dateMatch;\n                });\n\n                const dataInView = filteredData.filter(row => {\n                    const latLng = new google.maps.LatLng(row.latitude, row.longitude);\n                    return bounds.contains(latLng);\n                });\n\n                const count = dataInView.length;\n                document.getElementById('record-count-number').textContent = count;\n            }\n            window.calculateRecordCount = calculateRecordCount;\n        }\n    "
    },
    {
      "tag": "script",
       "attributes": {
        "src": "https://maps.googleapis.com/maps/api/js?key=AIzaSyBRxz4GVtvGG_rrW3QAmC_gtUG-mYckcvo&map_ids=39252d46211cfba9&libraries=visualization&callback=initMap",
         "async": true,
        "defer": true
       }
    },
    {
      "tag": "script",
      "attributes": {
        "src": "https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"
      }
    }
  ]
}
