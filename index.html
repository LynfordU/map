<div id="map"></div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRxz4GVtvGG_rrW3QAmC_gtUG-mYckcvo&map_ids=39252d46211cfba9&callback=initMap" async defer></script>
<script>
    function initMap() {
        console.log("initMap called");
        const map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 37.7749, lng: -122.4194 },
            zoom: 12,
            mapId: "39252d46211cfba9",
        });
        
        fetchDataFromBuckets(map);
    }
    function fetchDataFromBuckets(map) {
        const bucketFiles = [
            {
                bucket: "contact-address-bucket",
                file: "contacts.csv"
            },
            {
                bucket: "deal-address-bucket",
                file: "deals.csv"
            },
            {
                bucket: "dealer-address-bucket",
                file: "dealers.csv"
            },
            {
                bucket: "manufacturer-address-bucket",
                file: "manufacturers.csv"
            }
        ];
        bucketFiles.forEach(({ bucket, file }) => {
            console.log(Fetching from bucket: ${bucket}, file: ${file});
            
            // Construct the public URL for the GCS bucket
            const url = https://storage.googleapis.com/${bucket}/${file};
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(HTTP error! status: ${response.status});
                    }
                    return response.text();
                })
                .then(csvData => {
                    console.log(Got data from ${bucket}/${file});
                    const markers = parseCSVAndCreateMarkers(csvData);
                    addMarkersToMap(map, markers);
                })
                .catch(error => {
                    console.error(Error with ${bucket}/${file}:, error);
                });
        });
    }
    function parseCSVAndCreateMarkers(csvData) {
        const lines = csvData.trim().split('\n');
        const headers = lines[0].split(',');
        const markers = [];
        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(',');
            if (row.length === headers.length) {
                const data = {};
                headers.forEach((header, index) => {
                    data[header.trim()] = row[index].trim();
                });
                
                // Look for latitude/longitude in various possible column names
                const latitude = data.latitude || data.lat;
                const longitude = data.longitude || data.lng || data.long;
                
                if (latitude && longitude) {
                    markers.push({
                        latitude: latitude,
                        longitude: longitude,
                        name: data.properties_shed_company || 
                              data.properties_manufacturer_name || 
                              data.properties_dealer_name || 
                              'Location'
                    });
                }
            }
        }
        console.log(Parsed ${markers.length} markers);
        return markers;
    }
    function addMarkersToMap(map, markers) {
        markers.forEach(markerData => {
            new google.maps.Marker({
                position: { 
                    lat: parseFloat(markerData.latitude), 
                    lng: parseFloat(markerData.longitude) 
                },
                map: map,
                title: markerData.name
            });
        });
    }
</script>
